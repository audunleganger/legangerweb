services:
    caddy:
        image: caddy:latest
        container_name: caddy
        ports:
            - "${CADDY_HTTP_PORT}:80"
            - "${CADDY_HTTPS_PORT}:443"
            - "${CADDY_HTTPS_PORT}:443/udp"
        environment:
            ROOT_HOST: ${ROOT_HOST}
            MATMENY_HOST: ${MATMENY_HOST}
            MATMENY_ALT_HOSTS: ${MATMENY_ALT_HOSTS}
            HEXUS_HOST: ${HEXUS_HOST}
        volumes:
            - ./caddy/conf:/etc/caddy
            - ./caddy/site:/srv
            - caddy_data:/data
            - caddy_config:/config
        networks:
            - legangerweb-net

    frontend:
        build:
            context: ./frontend
            dockerfile: docker/Dockerfile.prod
        container_name: frontend
        expose:
            - "3000"
        networks:
            - legangerweb-net
        restart: unless-stopped

    matmeny-frontend:
        build:
            context: ./matmeny/frontend
            dockerfile: docker/Dockerfile.prod
        container_name: matmeny-frontend
        expose:
            - "3000"
        restart: unless-stopped
        networks:
            - legangerweb-net

    matmeny-backend:
        build:
            context: ./matmeny/backend
            dockerfile: docker/Dockerfile.prod
        container_name: matmeny-backend
        expose:
            - "8000"
        environment:
            DATABASE_URL: postgresql://${MATMENY_DB_USER}:${MATMENY_DB_PASSWORD}@matmeny-db:${MATMENY_DB_PORT}/${MATMENY_DB_NAME}
        depends_on:
            - matmeny-db
        restart: unless-stopped
        networks:
            - legangerweb-net

    matmeny-db:
        image: postgres:17-alpine
        container_name: matmeny-db
        environment:
            POSTGRES_USER: ${MATMENY_DB_USER}
            POSTGRES_PASSWORD: ${MATMENY_DB_PASSWORD}
            POSTGRES_DB: ${MATMENY_DB_NAME}
        volumes:
            - ./matmeny/db/data:/var/lib/postgresql/data
            - ./matmeny/db/initdb:/docker-entrypoint-initdb.d
        restart: unless-stopped
        expose:
            - "5432"
        networks:
            - legangerweb-net

    hexus:
        build:
            context: ./hexus
            dockerfile: docker/Dockerfile.prod
        container_name: hexus
        restart: unless-stopped
        expose:
            - "30000"
        networks:
            - legangerweb-net

volumes:
    caddy_data:
    caddy_config:

networks:
    legangerweb-net:
        name: legangerweb-net
        driver: bridge
